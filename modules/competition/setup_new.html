<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Competition ‚Ä¢ ARENA</title>
    <link rel="stylesheet" href="../../styles.css" />
    <script src="../../shared/core.js"></script>
    <script src="../../shared/state.js"></script>
    <script src="../../shared/ui.js"></script>
    <script src="../../shared/presets.js"></script>
    <script src="../../shared/preset_adapter.js"></script>


    <style>
        :root {
            --blue: #2563eb;
            --navy: #1e3a8a;
            --orange: #F37021;
            --ink: #0f172a;
            --muted: #6b7280;
            --line: #e5e7eb;
            --bg: #ffffff;
            --chip: #111827;
            --soft: #f8fafc;
        }

        body {
            background: #fafafa;
            color: var(--ink);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
        }

        /* Hero header ‚Üí full-width blue gradient (center style) */
        header {
            background: linear-gradient(180deg, var(--blue) 0%, var(--navy) 100%);
            color: #fff;
            padding: 72px 24px 96px;
            border-bottom: 1px solid rgba(0, 0, 0, .15);
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 800;
            letter-spacing: .2px;
        }

        header .sub {
            opacity: .95;
            font-size: 14px;
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ‚ÄúFloating‚Äù content overlap under hero */
        .wrap {
            max-width: 1100px;
            margin: -56px auto 0;
            padding: 0 20px 28px;
        }

        /* Top bar container */
        .bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            margin: 0 0 16px;
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 10px 26px rgba(0, 0, 0, .06);
        }

        @media (max-width: 860px) {
            .bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            border: 1px solid var(--chip);
            border-radius: 10px;
            padding: 10px 14px;
            text-decoration: none;
            background: #fff;
            color: var(--chip);
            font-weight: 700;
            transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
            cursor: pointer;
        }

        .btn:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
        }

        .btn.primary {
            background: #2563eb;
            color: #fff;
            border-color: #1e40af;
        }

        .btn.primary:hover {
            background: #1e40af;
            border-color: #1e3a8a;
            box-shadow: 0 6px 16px rgba(37, 99, 235, .28);
        }

        .btn.warn {
            border-color: #ef4444;
            color: #ef4444;
            background: #fff;
        }

        .btn.sm {
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 600;
        }

        .flex {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Cards */
        .card {
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
        }

        .card h3 {
            margin: 0 0 8px;
            font-size: 18px;
            font-weight: 800;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

        /* Inputs */
        label {
            font-size: 13px;
            color: var(--muted);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color .2s, box-shadow .2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, .18);
        }

        /* Pills / tags */
        .pill,
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            font-size: 12px;
            color: #0f172a;
            background: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .2);
        }

        .ok {
            color: #22c55e;
        }

        .bad {
            color: #ef4444;
        }

        /* Tables (works for both plain `table` and `.table`) */
        #l9_master_tbody,
        #l9_roster_tbody {
            font-size: 14px;
        }

        table,
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--line);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
        }

        thead th,
        .table th {
            background: #f8fafc;
            font-weight: 800;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th,
        td,
        .table th,
        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--line);
            font-size: 14px;
            text-align: left;
            vertical-align: middle;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:nth-child(even) {
            background: #fcfdff;
        }

        tbody tr:hover {
            background: #f3f6ff;
        }

        /* Scroll safety for wide tables */
        .card>.table,
        .card>table {
            min-width: 720px;
        }

        .card {
            overflow-x: auto;
        }

        /* Messages */
        #msg {
            margin-top: 10px;
        }
    </style>

</head>

<body>
    <header>
        <h1>Create Competition</h1>
        <div class="sub">
            <span id="cidBadge" class="pill"></span>
            &nbsp;‚Ä¢&nbsp;<span id="pctBadge" class="pill">0% complete</span>
            &nbsp;‚Ä¢&nbsp;<span id="statusBadge" class="pill">Draft</span>
        </div>
    </header>

    <main class="wrap">
        <div class="bar">
            <div class="muted">Fill required sections, then <strong>Approve & Activate</strong>.</div>
            <div class="flex">
                <a class="btn" href="./setup.html">‚¨ÖÔ∏è Back to Setup List</a>
                <button id="btnSave" class="btn">üíæ Save Draft</button>
                <button id="btnValidate" class="btn">‚úÖ Validate</button>
                <button id="btnPresetMapper" class="btn">üß© Preset Mapper</button>
                <button id="btnApprove" class="btn primary">üöÄ Approve & Activate</button>

            </div>
        </div>

        <!-- Section: Identity -->
        <section class="card">
            <h3>Identity</h3>

            <!-- Preset selection (optional) -->
            <div class="field" style="margin-bottom:12px;">
                <label for="presetSelect"><strong>Preset (optional)</strong></label>
                <select id="presetSelect" style="padding:8px;border-radius:8px;border:1px solid #cbd5e1;width:100%">
                    <option value="">‚Äî Select Preset ‚Äî</option>
                </select>
                <div id="presetDisciplineAlert" style="display:none;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #f97316;background:#fff7ed;color:#9a3412;font-size:13px;"></div>
            </div>

            <div class="grid">
                <div><label>CID</label><input id="f_cid" placeholder="Auto" /></div>
                <div><label>Name *</label><input id="f_name" placeholder="Competition name" /></div>
                <div><label>Federation</label><input id="f_federation" placeholder="e.g., National Federation" /></div>
                <select id="f_fid_selector" style="margin-top:6px; width:100%; max-width:240px">
                    <option value="">Select Federation ID</option>
                </select>

                <input type="hidden" id="fid" />
                <div><label>Status</label>
                    <select id="f_status">
                        <option>Draft</option>
                        <option>Pending</option>
                        <option>Approved</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Section: Schedule & Venue -->
        <section class="card">
            <h3>Schedule & Venue</h3>
            <div class="grid">
                <div><label>Start Date *</label><input id="f_start" type="date" /></div>
                <div><label>End Date *</label><input id="f_end" type="date" /></div>
                <div><label>Timezone *</label><input id="f_tz" placeholder="e.g., Asia/Kuala_Lumpur" /></div>
                <div><label>Venue *</label><input id="f_venue" placeholder="Venue name" /></div>
                <div><label>City</label><input id="f_city" placeholder="City" /></div>
                <div><label>Country</label><input id="f_country" placeholder="Country" /></div>
            </div>
        </section>

        <!-- ‚úÖ New Section: Competition Parameters -->
        <section class="card">
            <h3>Competition Parameters</h3>
            <div class="grid">
                <div>
                    <label>Runs per Athlete</label>
                    <input id="p_runsPerAthlete" type="number" min="1" placeholder="e.g. 3">
                </div>
                <div>
                    <label>Tricks per Round</label>
                    <input id="p_tricksPerRound" type="number" min="0" placeholder="e.g. 5">
                </div>
                <div>
                    <label>Advancement Rule (Top N)</label>
                    <input id="p_advancementTopN" type="number" min="1" placeholder="e.g. 8">
                </div>
            </div>
        </section>

        <!-- === Preset Parameters Editor (Phase C) === -->
        <section class="card" id="presetParamsCard">
            <h3>Preset Parameters</h3>
            <p class="muted">Fine-tune competition settings loaded from the preset.</p>

            <div class="grid">
                <div>
                    <label>Discipline</label>
                    <input id="p_discipline" type="text" readonly />
                </div>
                <div>
                    <label>Runs per Athlete</label>
                    <input id="p_runsPerAthlete" type="number" min="1" max="5" step="1" />
                </div>
                <div>
                    <label>Tricks per Round</label>
                    <input id="p_tricksPerRound" type="number" min="0" max="10" step="1" />
                </div>
                <div>
                    <label>Judges Panel Size</label>
                    <input id="p_judges" type="number" min="1" max="7" step="1" />
                </div>
                <div>
                    <label>Run Time (sec)</label>
                    <input id="p_runTime" type="number" min="30" max="90" step="5" />
                </div>
                <div>
                    <label>Advancement Top N</label>
                    <input id="p_advancementTopN" type="number" min="1" max="16" step="1" />
                </div>
                <div>
                    <label>Scoring Format</label>
                    <input id="p_scoringFormat" type="text" readonly />
                </div>
            </div>
        </section>

        <!-- === Competition Summary (Phase B4) === -->
        <section class="card" id="summaryBlock" style="margin-top:16px;">
            <h3>Competition Summary</h3>
            <p class="muted">Quick preview of the active preset and key parameters.</p>
            <table>
                <tbody>
                    <tr>
                        <td><b>Discipline</b></td>
                        <td id="s_discipline">‚Äî</td>
                    </tr>
                    <tr>
                        <td><b>Rounds</b></td>
                        <td id="s_rounds">‚Äî</td>
                    </tr>
                    <tr>
                        <td><b>Runs per Athlete</b></td>
                        <td id="s_runs">‚Äî</td>
                    </tr>
                    <tr>
                        <td><b>Tricks per Round</b></td>
                        <td id="s_tricks">‚Äî</td>
                    </tr>
                    <tr>
                        <td><b>Run Time (sec)</b></td>
                        <td id="s_runtime">‚Äî</td>
                    </tr>
                    <tr>
                        <td><b>Judges Panel</b></td>
                        <td id="s_judges">‚Äî</td>
                    </tr>
                    <tr>
                        <td><b>Scoring Format</b></td>
                        <td id="s_scoring">‚Äî</td>
                    </tr>
                    <tr>
                        <td><b>Advancement</b></td>
                        <td id="s_adv">‚Äî</td>
                    </tr>
                </tbody>
            </table>
        </section>


        <!-- Section: Events -->
        <section class="card">
            <h3>Events / Categories</h3>
            <div class="flex">
                <input id="ev_name" placeholder="Event name (e.g., Inline Freestyle)" />
                <select id="ev_class">
                    <option value="">Class</option>
                    <option>Junior</option>
                    <option>Open</option>
                    <option>Masters</option>
                </select>
                <select id="ev_gender">
                    <option value="">Gender</option>
                    <option>Mixed</option>
                    <option>Male</option>
                    <option>Female</option>
                </select>
                <button id="addEvent" class="btn">‚ûï Add Event</button>
            </div>
            <div style="margin-top:10px">
                <!-- L9: Roster Linker (Approved ‚Üí Competition) -->
                <div id="l9_roster_linker" style="margin-top:16px">
                    <div class="flex" style="align-items:center; gap:12px; margin-bottom:8px">
                        <h4 style="margin:0">Approved Athletes ‚Üí Competition Roster</h4>
                        <span class="tag" id="l9_count_master">0</span>
                        <span class="tag" id="l9_count_roster">0</span>
                        <input id="l9_search" placeholder="Search name / NSID / club"
                            style="margin-left:auto; max-width:280px" />
                    </div>

                    <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
                        <!-- Left: Approved master (source) -->
                        <div class="card" style="padding:12px">
                            <div class="muted" style="margin-bottom:8px">Approved list (federation-scoped)</div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width:42%">Name</th>
                                        <th>NSID</th>
                                        <th>Club</th>
                                        <th style="width:88px">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="l9_master_tbody"></tbody>
                            </table>
                        </div>

                        <!-- Right: Competition roster (target) -->
                        <div class="card" style="padding:12px">
                            <div class="muted" style="margin-bottom:8px">This competition‚Äôs roster</div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width:42%">Name</th>
                                        <th>AID</th>
                                        <th>Category</th>
                                        <th style="width:88px">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="l9_roster_tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- /L9: Roster Linker -->

                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Class</th>
                            <th>Gender</th>
                            <th style="width:100px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="events_tbody"></tbody>
                </table>
            </div>
        </section>

        <!-- Section: Judging & Criteria -->
        <section class="card">
            <h3>Judging & Criteria</h3>
            <div class="grid">
                <div><label>Panel Size *</label><input id="j_panel" type="number" min="1" placeholder="e.g., 5" /></div>
            </div>
            <div class="flex" style="margin-top:8px">
                <input id="cr_label" placeholder="Criteria label (e.g., Execution)" />
                <input id="cr_weight" type="number" min="0" max="100" placeholder="Weight (0‚Äì100)" />
                <button id="addCrit" class="btn">‚ûï Add Criteria</button>
            </div>
            <div style="margin-top:10px">
                <table>
                    <thead>
                        <tr>
                            <th>Criteria</th>
                            <th>Weight</th>
                            <th style="width:100px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="crit_tbody"></tbody>
                </table>
                <div class="muted" id="critTotalNote">Total weight: 0</div>
            </div>
        </section>

        <!-- Section: Heats Template -->
        <section class="card">
            <h3>Heats Template</h3>
            <div class="grid">
                <div><label>Default Heat Size *</label><input id="h_size" type="number" min="1" placeholder="e.g., 6" />
                </div>
                <div><label>Seeding Rule</label><input id="h_seed" placeholder="e.g., random/top-seeded" /></div>
                <div><label>Advancement Rule</label><input id="h_adv" placeholder="e.g., top-2 advance" /></div>
            </div>
        </section>

        <!-- Section: Officials -->
        <section class="card">
            <h3>Officials & Roles</h3>
            <div id="rolesRegistryPreview" style="margin:10px 0;padding:12px;border:1px solid var(--line);border-radius:12px;background:var(--soft);font-size:13px;color:var(--muted);"></div>
            <div class="flex">
                <input id="of_role" placeholder="Role (e.g., Director)" />
                <input id="of_name" placeholder="Name" />
                <input id="of_contact" placeholder="Contact" />
                <button id="addOff" class="btn">‚ûï Add</button>
            </div>
            <div style="margin-top:10px">
                <table>
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th>Name</th>
                            <th>Contact</th>
                            <th style="width:100px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="off_tbody"></tbody>
                </table>
            </div>
        </section>

        <!-- Section: Athletes -->
        <section class="card">
            <h3>Athletes</h3>
            <div class="muted">You can import from Athlete module later. Add manually for now (optional).</div>
            <div class="flex" style="margin-top:8px">
                <input id="at_name" placeholder="Athlete name" />
                <input id="at_nation" placeholder="Nation/Club" />
                <input id="at_cat" placeholder="Category (optional)" />
                <button id="addAth" class="btn">‚ûï Add</button>
            </div>
            <div style="margin-top:10px">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Nation/Club</th>
                            <th>Category</th>
                            <th style="width:100px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ath_tbody"></tbody>
                </table>
            </div>
        </section>

        <!-- Section: Policies & Publishing -->
        <section class="card">
            <h3>Policies & Publishing</h3>
            <div class="grid">
                <div><label>Tie-break Rule</label><input id="p_tie" placeholder="Explain rule" /></div>
                <div><label>Safety Notes</label><input id="p_safe" placeholder="Notes" /></div>
                <div><label>Public Title</label><input id="pb_title" placeholder="Title for public pages" /></div>
                <div><label>Slug</label><input id="pb_slug" placeholder="e.g., kl-open-2025" /></div>
                <div><label>Show Start List</label>
                    <select id="pb_start">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div><label>Show Live</label>
                    <select id="pb_live">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Validation messages -->
        <section id="msg" class="muted" style="margin-top:10px"></section>
    </main>

    <script>
        (function () {
            // ---------- Storage helpers ----------
            const KEY_SETUP = 'arena_competitions_setup';         // staging array
            const KEY_ACTIVE = 'competitions_active';             // approved index

            const $ = sel => document.querySelector(sel);
            const byId = id => document.getElementById(id);

            function loadSetupList() {
                try { const v = JSON.parse(localStorage.getItem(KEY_SETUP)); return Array.isArray(v) ? v : (v ? Object.values(v) : []); } catch (_) { return []; }
            }
            function saveSetupList(arr) {
                localStorage.setItem(KEY_SETUP, JSON.stringify(arr));
            }
            function upsertSetup(rec) {
                const arr = loadSetupList();
                const i = arr.findIndex(x => x.cid === rec.cid);
                if (i >= 0) arr[i] = rec; else arr.push(rec);
                saveSetupList(arr);
            }
            function getSetup(cid) {
                return loadSetupList().find(x => x.cid === cid) || null;
            }

            // ---------- Active writers (promotion) ----------
            function writeActiveIndex(entry) { // competitions_active (array of basics)
                const idx = (() => {
                    try { const v = JSON.parse(localStorage.getItem(KEY_ACTIVE)); return Array.isArray(v) ? v : []; } catch (_) { return []; }
                })();
                const i = idx.findIndex(x => x.cid === entry.cid);
                if (i >= 0) idx[i] = entry; else idx.push(entry);
                localStorage.setItem(KEY_ACTIVE, JSON.stringify(idx));
            }
            function writeEvents(cid, events) {
                localStorage.setItem('events_' + cid, JSON.stringify(events || []));
            }
            function writeJudges(cid, judging) {
                // create placeholder panel with size only; roles optional
                const panel = { panelSize: Number(judging?.panelSize || 0), roles: (judging?.roles || []) };
                localStorage.setItem('judges_' + cid, JSON.stringify(panel));
            }
            function writeAthletes(cid, athletes) {
                localStorage.setItem('athletes_' + cid, JSON.stringify(athletes || []));
            }
            function writeHeatsTemplates(cid, events, template) {
                (events || []).forEach(ev => {
                    const key = 'heats_' + cid + '_' + (ev.eid || ev.name || 'EVT');
                    const shell = { defaultSize: Number(template?.heatSize || 0), seeding: template?.seeding || '', advancement: template?.advancement || '', heats: [] };
                    localStorage.setItem(key, JSON.stringify(shell));
                });
            }

            // ---------- Form state ----------
            function genCID() { return 'CID_' + Date.now(); }
            const url = new URL(location.href);
            const paramCid = url.searchParams.get('cid');
            const isEdit = !!paramCid;

            // ---------- UI binds ----------
            const f = {
                cid: byId('f_cid'), name: byId('f_name'), federation: byId('f_federation'), status: byId('f_status'),
                start: byId('f_start'), end: byId('f_end'), tz: byId('f_tz'), venue: byId('f_venue'), city: byId('f_city'), country: byId('f_country'),
                jPanel: byId('j_panel'), hSize: byId('h_size'), hSeed: byId('h_seed'), hAdv: byId('h_adv'),
                pTie: byId('p_tie'), pSafe: byId('p_safe'), pbTitle: byId('pb_title'), pbSlug: byId('pb_slug'), pbStart: byId('pb_start'), pbLive: byId('pb_live')
            };
            const tb = {
                events: byId('events_tbody'), crit: byId('crit_tbody'), off: byId('off_tbody'), ath: byId('ath_tbody')
            };
            const btn = { save: byId('btnSave'), validate: byId('btnValidate'), approve: byId('btnApprove') };
            const msg = byId('msg');
            const badges = { cid: byId('cidBadge'), pct: byId('pctBadge'), status: byId('statusBadge'), critTotalNote: byId('critTotalNote') };

            const model = {
                cid: paramCid || genCID(),
                name: '', federation: '', status: 'Draft',
                schedule: { startDate: '', endDate: '', timezone: '', venue: '', city: '', country: '' },
                events: [], judging: { panelSize: 0, roles: [], criteria: [] },
                heatsTemplate: { heatSize: 0, seeding: '', advancement: '' },
                officials: [], athletes: [],
                policies: { tiebreak: '', safety: '', notes: '' },
                publishing: { publicTitle: '', slug: '', showStartList: true, showLive: true },
                meta: { createdAt: Date.now(), updatedAt: Date.now(), createdBy: 'admin' }
            };

            function validatePresetSnapshot(cid, opts = {}) {
                const silent = !!opts.silent;
                if (!cid) return { missing: ['cid missing'], snapshot: null };
                const snap = State.getJSON('preset_snapshot_' + cid, null);
                const missing = [];
                if (!snap || typeof snap !== 'object') { missing.push('snapshot missing'); }
                else {
                    if (!(Number(snap.runsPerAthlete) > 0)) missing.push('runsPerAthlete');
                    if (!Array.isArray(snap.rounds) || snap.rounds.length === 0) missing.push('rounds');
                    if (!(Number(snap.judges) > 0)) missing.push('judges');
                    if (typeof snap.dropHighLow !== 'boolean') missing.push('dropHighLow');
                    if (!(Number(snap.advancementTopN) > 0)) missing.push('advancementTopN');
                }
                if (!silent) {
                    if (missing.length) {
                        console.warn(`‚ö† Missing: ${missing.join(', ')}`, { cid, snapshot: snap });
                    } else {
                        console.log('‚úÖ Preset complete', { cid });
                    }
                }
                return { missing, snapshot: snap };
            }

            function updateDisciplineBanner() {
                const alertEl = document.getElementById('presetDisciplineAlert');
                if (!alertEl) return;
                const snapshotInfo = validatePresetSnapshot(model.cid, { silent: true });
                const snap = snapshotInfo.snapshot || window.model?.preset || {};
                const base = (snap?.discipline || '').trim();
                if (!base) {
                    alertEl.style.display = 'none';
                    alertEl.textContent = '';
                    alertEl.dataset.warned = '';
                    return;
                }
                const mismatches = (model.events || []).filter(ev => {
                    const evDisc = ((ev?.preset?.discipline || ev?.discipline || '')).trim();
                    return evDisc && evDisc.toLowerCase() !== base.toLowerCase();
                });
                if (!mismatches.length) {
                    alertEl.style.display = 'none';
                    alertEl.textContent = '';
                    alertEl.dataset.warned = '';
                    return;
                }
                const list = mismatches.map(ev => `${ev.name || ev.eid || 'event'} (${ev?.preset?.discipline || ev?.discipline || '‚Äî'})`).join(', ');
                const message = `‚ö† Discipline mismatch: preset=${base} / event=${list}`;
                alertEl.textContent = message;
                alertEl.style.display = 'block';
                if (!alertEl.dataset.warned) {
                    console.warn(message, { cid: model.cid });
                    alertEl.dataset.warned = '1';
                }
            }

            function syncUIfromModel() {
                f.cid.value = model.cid;
                f.name.value = model.name;
                f.federation.value = model.federation;
                f.status.value = model.status || 'Draft';

                f.start.value = model.schedule.startDate || '';
                f.end.value = model.schedule.endDate || '';
                f.tz.value = model.schedule.timezone || '';
                f.venue.value = model.schedule.venue || '';
                f.city.value = model.schedule.city || '';
                f.country.value = model.schedule.country || '';

                f.jPanel.value = model.judging.panelSize || '';
                f.hSize.value = model.heatsTemplate.heatSize || '';
                f.hSeed.value = model.heatsTemplate.seeding || '';
                f.hAdv.value = model.heatsTemplate.advancement || '';

                f.pTie.value = model.policies.tiebreak || '';
                f.pSafe.value = model.policies.safety || '';
                f.pbTitle.value = model.publishing.publicTitle || '';
                f.pbSlug.value = model.publishing.slug || '';
                f.pbStart.value = String(!!model.publishing.showStartList);
                f.pbLive.value = String(!!model.publishing.showLive);

                renderEvents(); renderCrit(); renderOff(); renderAth();
                updateBadges();
            }

            function readModelFromUI() {
                model.cid = f.cid.value.trim() || model.cid;
                model.name = f.name.value.trim();
                model.federation = f.federation.value.trim();
                model.status = f.status.value;

                model.schedule.startDate = f.start.value;
                model.schedule.endDate = f.end.value;
                model.schedule.timezone = f.tz.value.trim();
                model.schedule.venue = f.venue.value.trim();
                model.schedule.city = f.city.value.trim();
                model.schedule.country = f.country.value.trim();

                model.judging.panelSize = Number(f.jPanel.value || 0);
                model.heatsTemplate.heatSize = Number(f.hSize.value || 0);
                model.heatsTemplate.seeding = f.hSeed.value.trim();
                model.heatsTemplate.advancement = f.hAdv.value.trim();

                model.policies.tiebreak = f.pTie.value.trim();
                model.policies.safety = f.pSafe.value.trim();

                model.publishing.publicTitle = f.pbTitle.value.trim();
                model.publishing.slug = f.pbSlug.value.trim();
                model.publishing.showStartList = (f.pbStart.value === 'true');
                model.publishing.showLive = (f.pbLive.value === 'true');

                model.meta.updatedAt = Date.now();
            }

            // ---------- Lists renderers ----------
            function renderEvents() {
                tb.events.innerHTML = (model.events || []).map((ev, i) => `
          <tr><td>${ev.name || ''}</td><td>${ev.class || ''}</td><td>${ev.gender || ''}</td>
          <td class="row-actions"><a href="#" data-x="ev-del" data-i="${i}">Delete</a></td></tr>`).join('');
                updateDisciplineBanner();
            }
            function renderCrit() {
                const total = (model.judging.criteria || []).reduce((s, c) => s + Number(c.weight || 0), 0);
                badges.critTotalNote.textContent = 'Total weight: ' + total;
                badges.critTotalNote.className = (total === 100) ? 'muted ok' : 'muted bad';
                tb.crit.innerHTML = (model.judging.criteria || []).map((c, i) => `
          <tr><td>${c.label || ''}</td><td>${c.weight || 0}</td>
          <td class="row-actions"><a href="#" data-x="cr-del" data-i="${i}">Delete</a></td></tr>`).join('');
            }
            function renderOff() {
                tb.off.innerHTML = (model.officials || []).map((o, i) => `
          <tr><td>${o.role || ''}</td><td>${o.name || ''}</td><td>${o.contact || ''}</td>
          <td class="row-actions"><a href="#" data-x="of-del" data-i="${i}">Delete</a></td></tr>`).join('');
                renderRolesPreview();
            }
            function renderAth() {
                tb.ath.innerHTML = (model.athletes || []).map((a, i) => `
          <tr><td>${a.name || ''}</td><td>${a.nation || ''}</td><td>${a.category || ''}</td>
          <td class="row-actions"><a href="#" data-x="at-del" data-i="${i}">Delete</a></td></tr>`).join('');
            }

            function renderRolesPreview() {
                const box = document.getElementById('rolesRegistryPreview');
                if (!box) return;
                const base = (State.getRolesRegistry ? State.getRolesRegistry(model.cid) : []);
                const list = Array.isArray(base) ? base.map(r => ({ ...r })) : [];
                (model.officials || []).forEach(off => {
                    const key = String(off?.role || '').toLowerCase();
                    const target = list.find(r => String(r.role || '').toLowerCase() === key);
                    if (target) {
                        target.name = off?.name || target.name || '';
                        target.contact = off?.contact || target.contact || '';
                    }
                });
                if (!list.length) {
                    box.innerHTML = '<div class="muted">No registry defined.</div>';
                    return;
                }
                box.innerHTML = list.map(r => {
                    const contact = r.contact ? ` <span style="color:#475569">(${r.contact})</span>` : '';
                    const name = r.name || '‚Äî';
                    return `<div style="display:flex;justify-content:space-between;gap:12px;"><span><strong>${r.role}</strong></span><span>${name}${contact}</span></div>`;
                }).join('');
            }

            function applyLockState() {
                const locked = State.isEventLocked ? State.isEventLocked(model.cid) : false;
                if (!locked) return;
                const presetSelect = document.getElementById('presetSelect');
                if (presetSelect) {
                    presetSelect.disabled = true;
                    presetSelect.title = 'Event locked';
                }
                const mapperBtn = document.getElementById('btnPresetMapper');
                if (mapperBtn) {
                    mapperBtn.disabled = true;
                    mapperBtn.title = 'Event locked';
                }
                ['p_runsPerAthlete', 'p_tricksPerRound', 'p_judges', 'p_runTime', 'p_advancementTopN', 'p_scoringFormat']
                    .forEach(id => {
                        const el = document.getElementById(id);
                        if (el) { el.disabled = true; el.title = 'Locked after validation'; }
                    });
                const notice = document.getElementById('rolesRegistryPreview');
                if (notice) {
                    notice.insertAdjacentHTML('beforeend', '<div style="margin-top:8px;color:#16a34a;">üîí Event locked after validation.</div>');
                }
            }

            // ---------- Add row handlers ----------
            byId('addEvent').addEventListener('click', () => {
                const name = byId('ev_name').value.trim();
                const cls = byId('ev_class').value.trim();
                const gen = byId('ev_gender').value.trim();
                if (!name) { alert('Enter event name'); return; }
                model.events.push({ eid: 'E' + (model.events.length + 1), name, class: cls, gender: gen, notes: '' });
                byId('ev_name').value = ''; byId('ev_class').value = ''; byId('ev_gender').value = '';
                renderEvents();
            });
            byId('addCrit').addEventListener('click', () => {
                const label = byId('cr_label').value.trim();
                const w = Number(byId('cr_weight').value || 0);
                if (!label) { alert('Enter criteria label'); return; }
                if (w < 0 || w > 100) { alert('Weight must be 0‚Äì100'); return; }
                model.judging.criteria.push({ key: 'C' + (model.judging.criteria.length + 1), label, weight: w });
                byId('cr_label').value = ''; byId('cr_weight').value = '';
                renderCrit();
            });
            byId('addOff').addEventListener('click', () => {
                const role = byId('of_role').value.trim();
                const name = byId('of_name').value.trim();
                const contact = byId('of_contact').value.trim();
                if (!role || !name) { alert('Enter role and name'); return; }
                model.officials.push({ role, name, contact });
                byId('of_role').value = ''; byId('of_name').value = ''; byId('of_contact').value = '';
                renderOff();
            });
            byId('addAth').addEventListener('click', () => {
                const name = byId('at_name').value.trim();
                const nation = byId('at_nation').value.trim();
                const cat = byId('at_cat').value.trim();
                if (!name) { alert('Enter athlete name'); return; }
                model.athletes.push({ aid: 'A' + (model.athletes.length + 1), name, nation, club: '', category: cat });
                byId('at_name').value = ''; byId('at_nation').value = ''; byId('at_cat').value = '';
                renderAth();
            });

            // ---------- Row delete (event delegation) ----------
            document.body.addEventListener('click', (e) => {
                const x = e.target.getAttribute('data-x');
                if (!x) return;
                e.preventDefault();
                const i = Number(e.target.getAttribute('data-i'));
                if (x === 'ev-del') { model.events.splice(i, 1); renderEvents(); }
                if (x === 'cr-del') { model.judging.criteria.splice(i, 1); renderCrit(); }
                if (x === 'of-del') { model.officials.splice(i, 1); renderOff(); }
                if (x === 'at-del') { model.athletes.splice(i, 1); renderAth(); }
            });

            // ---------- Completion % ----------
            function completion() {
                let filled = 0, total = 7;
                if (model.name) filled++;
                if (model.schedule.startDate && model.schedule.endDate) filled++;
                if (model.schedule.venue) filled++;
                if (model.schedule.timezone) filled++;
                if (model.events && model.events.length) filled++;
                if (Number(model.judging.panelSize) > 0) filled++;
                if ((model.judging.criteria || []).reduce((s, c) => s + Number(c.weight || 0), 0) === 100) filled++;
                return Math.round((filled / total) * 100);
            }
            function updateBadges() {
                badges.cid.textContent = 'CID: ' + model.cid;
                badges.pct.textContent = completion() + '% complete';
                badges.status.textContent = model.status || 'Draft';
            }

            // ---------- Validation ----------
            function validate() {
                readModelFromUI();
                const missing = [];
                if (!model.name) missing.push('Name');
                if (!model.schedule.startDate || !model.schedule.endDate) missing.push('Dates');
                if (!model.schedule.timezone) missing.push('Timezone');
                if (!model.schedule.venue) missing.push('Venue');
                if (!model.events.length) missing.push('At least 1 Event');
                if (!(Number(model.judging.panelSize) > 0)) missing.push('Panel Size');
                const critSum = (model.judging.criteria || []).reduce((s, c) => s + Number(c.weight || 0), 0);
                if (critSum !== 100) missing.push('Criteria weights must total 100 (now ' + critSum + ')');

                if (missing.length) {
                    msg.innerHTML = '‚ùå Missing/Invalid: ' + missing.join(', ');
                    msg.style.color = '#ef4444';
                    return false;
                } else {
                    msg.innerHTML = '‚úÖ Looks good.';
                    msg.style.color = '#22c55e';
                    return true;
                }
            }

            function setBusy(el, busy, labelBusy, labelIdle) {
                if (!el) return;
                if (busy) {
                    el.dataset._label = el.textContent;
                    el.textContent = labelBusy;
                    el.disabled = true;
                } else {
                    el.textContent = labelIdle || el.dataset._label || el.textContent;
                    el.disabled = false;
                }
            }

            // SAVE DRAFT (with feedback)
            btn.save.addEventListener('click', () => {
                setBusy(btn.save, true, 'Saving‚Ä¶', 'üíæ Save Draft');
                readModelFromUI();
                upsertSetup(model);
                updateBadges();
                msg.innerHTML = 'üíæ Draft saved.';
                msg.style.color = '#111827';
                setTimeout(() => setBusy(btn.save, false, '', 'üíæ Save Draft'), 500);
            });

            // VALIDATE (with feedback)
            btn.validate.addEventListener('click', () => {
                setBusy(btn.validate, true, 'Validating‚Ä¶', '‚úÖ Validate');
                const ok = validate();
                updateBadges();
                setTimeout(() => {
                    setBusy(btn.validate, false, '', '‚úÖ Validate');
                    if (ok) { msg.innerHTML = '‚úÖ Looks good.'; msg.style.color = '#22c55e'; }
                }, 400);
            });

            // APPROVE & ACTIVATE (with feedback)
            btn.approve.addEventListener('click', () => {
                const presetCheck = validatePresetSnapshot(model.cid);
                if (presetCheck.missing.length) {
                    msg.innerHTML = '‚ùå Preset incomplete: ' + presetCheck.missing.join(', ');
                    msg.style.color = '#ef4444';
                    try { UI.toast('Preset incomplete: ' + presetCheck.missing.join(', ')); } catch (_) { }
                    return;
                }
                setBusy(btn.approve, true, 'Activating‚Ä¶', 'üöÄ Approve & Activate');
                if (!validate()) { setBusy(btn.approve, false); return; }

                // --- Phase B: attach preset snapshot if available ---
                try {
                    const cid = model.cid;
                    const presetSnap = State.getJSON('preset_snapshot_' + cid, null);
                    if (presetSnap) {
                        model.preset = presetSnap;
                        console.log('Preset snapshot attached:', presetSnap);
                    }
                } catch (err) {
                    console.warn('No preset snapshot found or failed to attach.', err);
                }


                // Write to active keys (index + per-CID stores)
                const activeEntry = {
                    cid: model.cid, name: model.name,
                    startDate: model.schedule.startDate, endDate: model.schedule.endDate,
                    venue: model.schedule.venue, city: model.schedule.city, country: model.schedule.country,
                    timezone: model.schedule.timezone,
                    publicTitle: model.publishing.publicTitle, slug: model.publishing.slug,
                    status: 'Active', approvedAt: Date.now()
                };
                writeActiveIndex(activeEntry);
                // Ensure each event carries the preset snapshot (for Event Admin / Run Console)
                if (model.preset && Array.isArray(model.events)) {
                    model.events = model.events.map(ev => ({
                        ...ev,
                        preset: ev.preset || { ...model.preset }  // don‚Äôt overwrite if already set
                    }));
                }
                writeEvents(model.cid, model.events);
                writeJudges(model.cid, model.judging);

                localStorage.setItem('scoring_' + model.cid, JSON.stringify({ criteria: model.judging.criteria || [] }));
                localStorage.setItem('display_' + model.cid, JSON.stringify({
                    publicTitle: model.publishing.publicTitle || model.name,
                    slug: model.publishing.slug || (model.cid || '').toLowerCase(),
                    showStartList: !!(model.publishing.showStartList),
                    showLive: !!(model.publishing.showLive)
                }));
                localStorage.setItem('officials_' + model.cid, JSON.stringify(model.officials || []));
                try {
                    const baseRoles = State.getRolesRegistry ? State.getRolesRegistry(model.cid)
                        : (State.ensureRolesRegistry ? State.ensureRolesRegistry(model.cid) : []);
                    const merged = Array.isArray(baseRoles) ? baseRoles.map(r => {
                        const key = String(r.role || '').toLowerCase();
                        const match = (model.officials || []).find(off => String(off.role || '').toLowerCase() === key);
                        return {
                            ...r,
                            name: match?.name || r.name || '',
                            contact: match?.contact || r.contact || ''
                        };
                    }) : [];
                    if (merged.length) {
                        if (State.writeRolesRegistry) {
                            State.writeRolesRegistry(model.cid, merged);
                        } else {
                            localStorage.setItem(`roles_${model.cid}`, JSON.stringify({ roles: merged, updatedAt: Date.now() }));
                        }
                        console.log('‚úÖ Roles registry synced', merged);
                    }
                } catch (err) {
                    console.warn('Failed to sync roles registry', err);
                }

                // MERGE manual athletes with existing L9 roster (no overwrite)
                (function () {
                    const G = window.__L9_GETTERS || {};
                    const cid = model.cid;

                    // local nextAid (same behavior as L9) to keep AIDs consistent
                    function nextAidLocal(cid) {
                        const k = `athletes_aid_cursor_${cid}`;
                        const cur = Number(localStorage.getItem(k) || '0') + 1;
                        localStorage.setItem(k, String(cur));
                        return 'A' + cur;
                    }

                    // existing L9 roster (athletes_<CID>)
                    const existing =
                        (G.loadRoster ? G.loadRoster(cid) : (JSON.parse(localStorage.getItem('athletes_' + cid) || '[]') || []));
                    const merged = Array.isArray(existing) ? existing.slice() : [];

                    // manual list from the setup form
                    const manual = Array.isArray(model.athletes) ? model.athletes : [];

                    // de-dupe (prefer NSID, fallback name|club) ‚Äî same logic as L9
                    const inRoster =
                        G.inRoster ||
                        function (roster, m) {
                            const nsid = (m?.nsid || '').trim();
                            if (nsid) return roster.some(r => (r.nsid || '').trim() === nsid);
                            const key = ((m?.name || '') + '|' + (m?.club || '')).toLowerCase();
                            return roster.some(r => ((r.name || '') + '|' + (r.club || '')).toLowerCase() === key);
                        };

                    // merge manual ‚Üí roster
                    for (const a of manual) {
                        if (!inRoster(merged, a)) {
                            merged.push({
                                aid: (a && a.aid && String(a.aid).trim()) ? String(a.aid).trim() : nextAidLocal(cid),
                                nsid: a?.nsid || '',
                                name: a?.name || '',
                                nation: a?.nation || '',
                                state: a?.state || '',
                                district: a?.district || '',
                                sex: a?.sex || '',
                                club: a?.club || '',
                                category: a?.category || ''
                            });
                        }
                    }

                    // write back via L9 writer (ticks + State cache) or fallback
                    if (G.writeRoster) {
                        G.writeRoster(cid, merged);
                    } else {
                        localStorage.setItem('athletes_' + cid, JSON.stringify(merged || []));
                        localStorage.setItem('athletes_tick_' + cid, String(Date.now()));
                    }
                })();

                // === Preset Snapshot (if selected) ===
                const presetId = document.getElementById('presetSelect')?.value || '';
                if (presetId) {
                    const preset = Preset.get(presetId);
                    if (preset) {
                        model.preset = {
                            id: presetId,
                            name: preset.name,
                            runsPerAthlete: preset.runsPerAthlete,
                            tricksPerRound: preset.tricksPerRound || 0,
                            judges: preset.judges,
                            judgingScale: preset.judgingScale,
                            dropHighLow: preset.dropHighLow,
                            advancementTopN: preset.advancementTopN,
                            scoringFormat: preset.scoringFormat
                        };
                    }
                }

                writeHeatsTemplates(model.cid, model.events, {
                    heatSize: model.heatsTemplate.heatSize,
                    seeding: model.heatsTemplate.seeding,
                    advancement: model.heatsTemplate.advancement
                });


                // Mark staging as Approved
                model.status = 'Approved';
                model.meta.updatedAt = Date.now();
                upsertSetup(model);
                updateBadges();

                msg.innerHTML = 'üöÄ Approved & activated. Data is now available to Run module.';
                msg.style.color = '#22c55e';
                setTimeout(() => setBusy(btn.approve, false, '', 'üöÄ Approve & Activate'), 800);
            });


            // ---------- Load existing or init new ----------
            const existing = isEdit ? getSetup(paramCid) : null;
            if (existing) {
                Object.assign(model, existing);
            } else {
                // keep generated CID; allow user to override before saving
            }
            syncUIfromModel();
            validatePresetSnapshot(model.cid);
            updateDisciplineBanner();
            applyLockState();
        })();
    </script>
    <script>
        /* L9 Step 3B.2: Initialize federation ID (fid) */
        (function () {
            const $ = (id) => document.getElementById(id);
            const url = new URL(location.href);
            const paramFid = (url.searchParams.get('fid') || '').trim();

            function deriveFID(name) {
                const tokens = (name || '').match(/[A-Za-z0-9]+/g) || [];
                const acronym = tokens.map(w => w[0]).join('').toUpperCase();
                return acronym.slice(0, 6); // generic, no hardcode, works for ‚ÄúMalaysia Skating Federation‚Äù -> MSF
            }

            function setFID() {
                const elHidden = $('fid');
                if (!elHidden) return;

                const fedName = ($('f_federation')?.value || '').trim();
                const stored = (localStorage.getItem('active_fid') || '').trim();

                // Priority: URL ?fid=  > stored active_fid  > derived from federation name  > empty
                const chosen = paramFid || stored || deriveFID(fedName);

                if (chosen) {
                    elHidden.value = chosen;
                    localStorage.setItem('active_fid', chosen);
                } else {
                    elHidden.value = '';
                }

                // Signal for later steps to react (if needed)
                document.dispatchEvent(new CustomEvent('l9-fid-ready', { detail: { fid: elHidden.value } }));
            }

            document.addEventListener('DOMContentLoaded', function () {
                setFID();
                const fed = $('f_federation');
                if (fed && !fed._wiredFID) {
                    fed._wiredFID = true;
                    fed.addEventListener('input', setFID);
                    fed.addEventListener('change', setFID);
                }
            });
        })();
    </script>

    <script>
        /* L9 Step 2: minimal boot (read + render only) */
        (function () {
            const $ = (id) => document.getElementById(id);

            function safeArr(v) { return Array.isArray(v) ? v : (v ? Object.values(v) : []); }

            function loadMasterApproved() {
                // Source: athletes_master
                const all = safeArr(State.arr(State.keys.athletesMaster));
                // L9 rule: only 'approved'
                // (Federation filtering will be added in next step once we hook the active FID source.)
                return all.filter(x => x && x.status === 'approved');
            }

            function loadRoster(cid) {
                // Target: athletes_<CID>
                return safeArr(State.arr(State.keys.athletes(cid)));
            }

            function render() {
                const cid = Core.getParam('cid');
                if (!cid) {
                    try { UI.toast('Missing CID in URL'); } catch (_) { }
                    return;
                }

                const master = loadMasterApproved();
                const roster = loadRoster(cid);

                // counts
                if ($('l9_count_master')) $('l9_count_master').textContent = master.length;
                if ($('l9_count_roster')) $('l9_count_roster').textContent = roster.length;

                // master table (no actions yet)
                if ($('l9_master_tbody')) {
                    $('l9_master_tbody').innerHTML = master.map(m => `
        <tr>
          <td>${m?.name ?? ''}</td>
          <td>${m?.nsid ?? ''}</td>
          <td>${m?.club ?? ''}</td>
          <td><button class="btn sm" disabled title="Add coming in Step 3">+ Add</button></td>
        </tr>
      `).join('');
                }

                // roster table (no actions yet)
                if ($('l9_roster_tbody')) {
                    $('l9_roster_tbody').innerHTML = roster.map(r => `
        <tr>
          <td>${r?.name ?? ''}</td>
          <td>${r?.aid ?? ''}</td>
          <td>${r?.category ?? ''}</td>
          <td><button class="btn sm" disabled title="Remove coming in Step 3">Remove</button></td>
        </tr>
      `).join('');
                }
            }

            document.addEventListener('DOMContentLoaded', render);
        })();
    </script>

    <script>
        /* L9 Step 3B.3: federation-scoped render + live search */
        (function () {
            const $ = (id) => document.getElementById(id);
            const safeArr = (v) => Array.isArray(v) ? v : (v ? Object.values(v) : []);

            function getFID() {
                const v = ($('fid')?.value || '').trim();
                return v || (localStorage.getItem('active_fid') || '').trim();
            }
            function getCID() {
                try { return new URL(location.href).searchParams.get('cid') || ''; } catch { return ''; }
            }

            function loadMasterApprovedByFID() {
                const fid = getFID();
                const all = safeArr(State.arr(State.keys.athletesMaster));
                // Only Approved + same federation
                return all.filter(x => (!fid || (x.fid || '').trim().toUpperCase() === fid.trim().toUpperCase()));
            }

            function loadRoster(cid) {
                return safeArr(State.arr(State.keys.athletes(cid)));
            }

            function renderBoth() {
                const cid = getCID();
                if (!cid) return;

                const master = loadMasterApprovedByFID();
                const roster = loadRoster(cid);

                if ($('l9_count_master')) $('l9_count_master').textContent = master.length;
                if ($('l9_count_roster')) $('l9_count_roster').textContent = roster.length;

                if ($('l9_master_tbody')) {
                    $('l9_master_tbody').innerHTML = master.map(m => `
        <tr>
          <td>${m?.name ?? ''}</td>
          <td>${m?.nsid ?? ''}</td>
          <td>${m?.club ?? ''}</td>
          <td><button class="btn sm" disabled title="Add coming in Step 4">+ Add</button></td>
        </tr>
      `).join('');
                }
                if ($('l9_roster_tbody')) {
                    $('l9_roster_tbody').innerHTML = roster.map(r => `
        <tr>
          <td>${r?.name ?? ''}</td>
          <td>${r?.aid ?? ''}</td>
          <td>${r?.category ?? ''}</td>
          <td><button class="btn sm" disabled title="Remove coming in Step 4">Remove</button></td>
        </tr>
      `).join('');
                }
            }

            // Live search (federation-scoped)
            function wireSearch() {
                const input = $('l9_search');
                if (!input || input._l9SearchWired) return;
                input._l9SearchWired = true;

                input.addEventListener('input', function () {
                    const q = (input.value || '').toLowerCase().trim();
                    const base = loadMasterApprovedByFID();
                    const filtered = !q ? base : base.filter(m => {
                        const s = `${m?.name ?? ''} ${m?.nsid ?? ''} ${m?.club ?? ''}`.toLowerCase();
                        return s.includes(q);
                    });
                    if ($('l9_count_master')) $('l9_count_master').textContent = filtered.length;
                    if ($('l9_master_tbody')) {
                        $('l9_master_tbody').innerHTML = filtered.map(m => `
          <tr>
            <td>${m?.name ?? ''}</td>
            <td>${m?.nsid ?? ''}</td>
            <td>${m?.club ?? ''}</td>
            <td><button class="btn sm" disabled title="Add coming in Step 4">+ Add</button></td>
          </tr>
        `).join('');
                    }
                });
            }

            // Initial + on fid ready
            document.addEventListener('DOMContentLoaded', function () {
                renderBoth();
                wireSearch();
            });
            document.addEventListener('l9-fid-ready', function () {
                renderBoth();
                wireSearch();
            });
        })();
    </script>
    <script>
        /* L9 Step 4A: helpers + full renderer (buttons enabled) */
        (function () {
            const $ = (id) => document.getElementById(id);
            const safeArr = (v) => Array.isArray(v) ? v : (v ? Object.values(v) : []);

            function getFID() {
                const v = ($('fid')?.value || '').trim();
                return v || (localStorage.getItem('active_fid') || '').trim();
            }
            function getCID() {
                try { return new URL(location.href).searchParams.get('cid') || ''; } catch { return ''; }
            }

            // ---- AID cursor (per CID) ----
            function nextAid(cid) {
                const k = `athletes_aid_cursor_${cid}`;
                const cur = Number(localStorage.getItem(k) || '0') + 1;
                localStorage.setItem(k, String(cur));
                return 'A' + cur;
            }

            // ---- Read stores ----
            function loadMasterApprovedByFID() {
                const fid = getFID();
                const all = safeArr(State.arr(State.keys.athletesMaster));
                return all.filter(x => (!fid || (x.fid || '').trim().toUpperCase() === fid.trim().toUpperCase()));
            }
            function loadRoster(cid) {
                return safeArr(State.arr(State.keys.athletes(cid)));
            }

            // ---- Write roster + tick ----
            function writeRoster(cid, roster) {
                try {
                    // Primary write (raw localStorage)
                    const rosterKey = 'athletes_' + cid;
                    const tickKey = 'athletes_tick_' + cid;
                    localStorage.setItem(rosterKey, JSON.stringify(roster || []));
                    localStorage.setItem(tickKey, String(Date.now()));

                    // Sync into State cache (for State.arr to read)
                    if (State && State.setJSON) State.setJSON(rosterKey, roster || []);
                    if (State && State.bumpTick) State.bumpTick(tickKey);
                } catch (e) {
                    console.error('L9 writeRoster error', e);
                }
            }


            // ---- Map master -> roster item (privacy-safe) ----
            function mapToRosterItem(m, cid) {
                return {
                    aid: nextAid(cid),
                    nsid: m?.nsid || '',
                    name: m?.name || '',
                    nation: m?.nation || '',
                    state: m?.state || '',
                    district: m?.district || '',
                    sex: m?.sex || '',
                    club: m?.club || '',
                    category: m?.category || ''   // keep as-is if present, else blank
                    // NOTE: no national_id copied
                };
            }

            // ---- De-dupe check by nsid (preferred) or name+club fallback ----
            function inRoster(roster, m) {
                const nsid = (m?.nsid || '').trim();
                if (nsid) return roster.some(r => (r.nsid || '').trim() === nsid);
                const key = ((m?.name || '') + '|' + (m?.club || '')).toLowerCase();
                return roster.some(r => ((r.name || '') + '|' + (r.club || '')).toLowerCase() === key);
            }

            // ---- Global render with enabled buttons ----
            function renderL9() {
                const cid = getCID();
                if (!cid) return;

                const master = loadMasterApprovedByFID();
                const roster = loadRoster(cid);

                if ($('l9_count_master')) $('l9_count_master').textContent = master.length;
                if ($('l9_count_roster')) $('l9_count_roster').textContent = roster.length;

                if ($('l9_master_tbody')) {
                    $('l9_master_tbody').innerHTML = master.map(m => `
        <tr>
          <td>${m?.name ?? ''}</td>
          <td>${m?.nsid ?? ''}</td>
          <td>${m?.club ?? ''}</td>
          <td>
            <button class="btn sm" data-x="l9-add" data-nsid="${m?.nsid ?? ''}">+ Add</button>
          </td>
        </tr>
      `).join('');
                }

                if ($('l9_roster_tbody')) {
                    $('l9_roster_tbody').innerHTML = roster.map(r => `
        <tr>
          <td>${r?.name ?? ''}</td>
          <td>${r?.aid ?? ''}</td>
          <td>${r?.category ?? ''}</td>
          <td>
            <button class="btn sm" data-x="l9-rem" data-aid="${r?.aid ?? ''}">Remove</button>
          </td>
        </tr>
      `).join('');
                }
            }

            // Expose for Step 4B
            window.__L9_RENDER = renderL9;
            window.__L9_GETTERS = { getCID, loadMasterApprovedByFID, loadRoster, mapToRosterItem, writeRoster, inRoster };

            // Render now and on fid-ready
            document.addEventListener('DOMContentLoaded', renderL9);
            document.addEventListener('l9-fid-ready', renderL9);
        })();
    </script>
    <script>
        /* L9 Step 4B: actions + write + tick + refresh */
        (function () {
            const $ = (id) => document.getElementById(id);

            function toast(msg) { try { UI.toast(msg); } catch (_) { console.log(msg); } }

            function findMasterByNSID(nsid) {
                const base = (window.__L9_GETTERS?.loadMasterApprovedByFID?.() || []);
                return base.find(m => (m?.nsid || '').trim() === (nsid || '').trim()) || null;
            }

            document.body.addEventListener('click', function (e) {
                const act = e.target?.getAttribute?.('data-x');
                if (!act) return;

                const G = window.__L9_GETTERS || {};
                const render = window.__L9_RENDER || function () { };

                const cid = G.getCID ? G.getCID() : '';
                if (!cid) return;

                if (act === 'l9-add') {
                    e.preventDefault();
                    const nsid = e.target.getAttribute('data-nsid') || '';
                    const masterRec = findMasterByNSID(nsid);
                    if (!masterRec) { toast('Not found in Approved list'); return; }

                    const roster = (G.loadRoster ? G.loadRoster(cid) : []);
                    if (G.inRoster && G.inRoster(roster, masterRec)) { toast('Already in roster'); return; }

                    const item = G.mapToRosterItem ? G.mapToRosterItem(masterRec, cid) : null;
                    if (!item) return;

                    const next = [...roster, item];
                    if (G.writeRoster) G.writeRoster(cid, next);

                    toast('Added to roster');
                    setTimeout(() => {
                        window.__L9_RENDER?.();
                    }, 50);


                    if ($('l9_search')) $('l9_search').dispatchEvent(new Event('input')); // keep filtered view consistent
                    return;
                }

                if (act === 'l9-rem') {
                    e.preventDefault();
                    const aid = e.target.getAttribute('data-aid') || '';
                    const roster = (G.loadRoster ? G.loadRoster(cid) : []);
                    const next = roster.filter(r => (r?.aid || '') !== aid);

                    if (next.length === roster.length) { toast('AID not found'); return; }

                    if (G.writeRoster) G.writeRoster(cid, next);

                    toast('Removed from roster');
                    setTimeout(() => {
                        window.__L9_RENDER?.();
                    }, 50);


                    if ($('l9_search')) $('l9_search').dispatchEvent(new Event('input'));
                    return;
                }
            });
            document.addEventListener('l9-refresh', () => {
                window.__L9_RENDER?.();
            });
        })();
    </script>
    <script>
        /* L9 Federation Selector */
        (function () {
            const $ = (id) => document.getElementById(id);

            function populateFIDSelector() {
                const sel = $('f_fid_selector');
                if (!sel) return;

                // Collect unique FIDs from athletes_master
                let list = [];
                try {
                    const all = State.arr(State.keys.athletesMaster) || [];
                    list = [...new Set(all.map(x => (x?.fid || '').trim()).filter(Boolean))];
                } catch (_) { }

                sel.innerHTML = '<option value="">Select Federation ID</option>' +
                    list.map(fid => `<option value="${fid}">${fid}</option>`).join('');

                // auto-select if hidden fid has a value
                const current = ($('fid')?.value || '').trim();
                if (current && list.includes(current)) sel.value = current;

                sel.addEventListener('change', function () {
                    const val = sel.value.trim();
                    if ($('fid')) $('fid').value = val;
                    localStorage.setItem('active_fid', val);
                    document.dispatchEvent(new CustomEvent('l9-fid-ready', { detail: { fid: val } }));
                    UI.toast('Federation set to ' + val);
                });
            }

            document.addEventListener('DOMContentLoaded', populateFIDSelector);
        })();

        // === Preset Dropdown Logic ===
        const presetSelect = document.getElementById('presetSelect');

        // Populate dropdown
        Preset.list().forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            presetSelect.appendChild(opt);
        });

        // When preset selected ‚Üí apply to form
        presetSelect.onchange = e => {
            const id = e.target.value;
            if (!id) return;

            const preset = Preset.get(id);
            if (!preset) return;

            UI.toast(`Preset loaded: ${preset.name}`);

            const map = {
                'f_name': preset.name,
                'f_discipline': preset.discipline,
                'f_rounds': preset.rounds.join(', '),
                'f_runsPerAthlete': preset.runsPerAthlete,
                'f_tricksPerRound': preset.tricksPerRound || '',
                'f_runTime': preset.runTime,
                'f_judges': preset.judges,
                'f_judgingScale': preset.judgingScale,
                'f_advancementTopN': preset.advancementTopN
            };

            for (let k in map) {
                const el = document.getElementById(k);
                if (el) el.value = map[k];
            }
        };

    </script>

    <script>
        (function () {
            const btn = document.getElementById('btnPresetMapper');
            if (!btn) return;
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                try {
                    // Prefer CID from the form; fallback to URL ?cid=
                    const cidInput = document.getElementById('f_cid');
                    const cid = (cidInput && cidInput.value) ? cidInput.value : (window.Core?.getParam('cid') || '');
                    const href = (window.Core && window.Core.buildUrl)
                        ? window.Core.buildUrl('./preset_mapper.html', { cid })
                        : './preset_mapper.html' + (cid ? ('?cid=' + encodeURIComponent(cid)) : '');
                    window.location.href = href;
                } catch (_) {
                    window.location.href = './preset_mapper.html';
                }
            });
        })();
    </script>
    <script>
        // === Phase B Fix ‚Äî Load Preset Snapshot on Page Load ===
        (function () {
            const cid = window.Core?.getParam('cid');
            if (!cid) return;
            const snapshot = localStorage.getItem('preset_snapshot_' + cid);
            if (!snapshot) return;
            try {
                const p = JSON.parse(snapshot);
                if (!window.model) window.model = {};
                window.model.preset = p;
                console.log('‚úÖ Preset snapshot loaded into model:', p);
                // trigger UI refresh
                document.dispatchEvent(new Event('presetChanged'));
            } catch (e) {
                console.error('Failed to parse preset snapshot', e);
            }
        })();
    </script>

    <script>
        // === Phase C2 ‚Äì Preset Parameters Auto-Fill + Edit ===
        (function () {
            const flds = {
                discipline: document.getElementById('p_discipline'),
                runsPerAthlete: document.getElementById('p_runsPerAthlete'),
                tricksPerRound: document.getElementById('p_tricksPerRound'),
                judges: document.getElementById('p_judges'),
                runTime: document.getElementById('p_runTime'),
                advancementTopN: document.getElementById('p_advancementTopN'),
                scoringFormat: document.getElementById('p_scoringFormat'),
            };

            // üîπ Auto-fill when model.preset exists
            function loadPresetToUI(p) {
                if (!p) return;
                if (flds.discipline) flds.discipline.value = p.discipline || '';
                if (flds.runsPerAthlete) flds.runsPerAthlete.value = p.runsPerAthlete ?? '';
                if (flds.tricksPerRound) flds.tricksPerRound.value = p.tricksPerRound ?? '';
                if (flds.judges) flds.judges.value = p.judges ?? '';
                if (flds.runTime) flds.runTime.value = p.runTime ?? '';
                if (flds.advancementTopN) flds.advancementTopN.value = p.advancementTopN ?? '';
                if (flds.scoringFormat) flds.scoringFormat.value = p.scoringFormat || '';
            }

            // üîπ Apply current UI values back into model.preset
            function syncPresetFromUI() {
                if (!window.model) return;
                window.model.preset = window.model.preset || {};
                const p = window.model.preset;
                p.discipline = flds.discipline?.value || '';
                p.runsPerAthlete = Number(flds.runsPerAthlete?.value) || 0;
                p.tricksPerRound = Number(flds.tricksPerRound?.value) || 0;
                p.judges = Number(flds.judges?.value) || 0;
                p.runTime = Number(flds.runTime?.value) || 0;
                p.advancementTopN = Number(flds.advancementTopN?.value) || 0;
                p.scoringFormat = flds.scoringFormat?.value || '';
                window.model.preset = p;
            }

            // üîπ Bind input events ‚Üí auto-save to model
            Object.values(flds).forEach(el => {
                if (!el) return;
                el.addEventListener('change', syncPresetFromUI);
            });

            // üîπ Run on page load (when model ready)
            window.addEventListener('DOMContentLoaded', () => {
                if (window.model?.preset) loadPresetToUI(window.model.preset);
            });
        })();
    </script>
    <script>
        // === Phase B3 ‚Äî Validate Competition Parameters ===
        (function () {
            const runs = document.getElementById('p_runsPerAthlete');
            const tricks = document.getElementById('p_tricksPerRound');
            const adv = document.getElementById('p_advancementTopN');

            function validateParams() {
                const r = Number(runs?.value || 0);
                const t = Number(tricks?.value || 0);
                const a = Number(adv?.value || 0);
                if (r < 1) { alert('Runs per Athlete must be at least 1.'); runs.focus(); return false; }
                if (r < 2) console.warn('Note: Most official events use 2‚Äì3 runs.');
                if (t < 0) { alert('Tricks per Round cannot be negative.'); tricks.focus(); return false; }
                if (a < 1) { alert('Advancement Top N must be at least 1.'); adv.focus(); return false; }
                return true;
            }

            // Hook into approve button (if exists)
            const approveBtn = document.getElementById('btnApprove');
            if (approveBtn) {
                approveBtn.addEventListener('click', e => {
                    if (!validateParams()) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            }
        })();
    </script>
    <script>
        // === Phase B4 ‚Äî Auto-Fill Competition Summary ===
        (function () {
            const s = {
                discipline: document.getElementById('s_discipline'),
                rounds: document.getElementById('s_rounds'),
                runs: document.getElementById('s_runs'),
                tricks: document.getElementById('s_tricks'),
                runtime: document.getElementById('s_runtime'),
                judges: document.getElementById('s_judges'),
                scoring: document.getElementById('s_scoring'),
                adv: document.getElementById('s_adv'),
            };

            function updateSummary() {
                const p = window.model?.preset || {};
                if (!p) return;
                s.discipline.textContent = p.discipline || '‚Äî';
                s.rounds.textContent = Array.isArray(p.rounds) ? p.rounds.join(', ') : (p.rounds || '‚Äî');
                s.runs.textContent = p.runsPerAthlete || '‚Äî';
                s.tricks.textContent = p.tricksPerRound || '‚Äî';
                s.runtime.textContent = p.runTime || '‚Äî';
                s.judges.textContent = p.judges || '‚Äî';
                s.scoring.textContent = p.scoringFormat || '‚Äî';
                s.adv.textContent = p.advancementTopN || '‚Äî';
            }

            // Run on load and whenever preset changes
            window.addEventListener('DOMContentLoaded', updateSummary);
            document.addEventListener('presetChanged', updateSummary);
            document.addEventListener('presetChanged', updateDisciplineBanner);
        })();
    </script>

</body>

</html>