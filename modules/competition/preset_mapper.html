<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Preset Mapper â€¢ XGAMES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body style="background:#f8fafc;padding:24px;font-family:sans-serif;">
  <h1>ðŸ§© Preset Mapper</h1>
  <p>Select a preset to view and confirm event parameters.</p>

  <label>Preset:</label>
  <select id="presetSelect"></select>

  <div id="presetDetails" style="margin-top:20px;">
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;">
      <tbody id="presetTableBody"></tbody>
    </table>
  </div>

  <button id="saveBtn" class="btn primary" style="margin-top:20px;">ðŸ’¾ Save & Return</button>

  <script src="/shared/core.js"></script>
  <script src="/shared/state.js"></script>
  <script src="/shared/presets.js"></script>
  <script src="/shared/preset_adapter.js"></script>
  <script src="/shared/ui.js"></script>

  <script>
    (function(){
      const cid = Core.getParam('cid');
      const select = document.getElementById('presetSelect');
      const tableBody = document.getElementById('presetTableBody');
      const saveBtn = document.getElementById('saveBtn');

      function auditPresetSnapshot() {
        if (!cid) return;
        const events = State.arr(State.keys.events(cid));
        events.forEach(ev => {
          if (ev?.preset) {
            console.log('Preset linked for event', { cid, eid: ev.eid, preset: ev.preset?.name || ev.preset?.id || 'custom' });
          } else {
            console.warn('Event missing preset linkage', { cid, eid: ev?.eid });
          }
        });
        const snap = State.ensurePresetSnapshot ? State.ensurePresetSnapshot(cid) : null;
        if (snap) {
          console.log(`âœ… Presets audited (${events.length} events)`, { cid });
        } else {
          console.warn('âš  Preset snapshot missing and no event preset available', { cid });
        }
      }

      auditPresetSnapshot();

      function evaluatePreset(p) {
        const missing = [];
        if (!p || typeof p !== 'object') return { missing: ['snapshot missing'], preset: null };
        if (!(Number(p.runsPerAthlete) > 0)) missing.push('runsPerAthlete');
        if (!Array.isArray(p.rounds) || p.rounds.length === 0) missing.push('rounds');
        if (!(Number(p.judges) > 0)) missing.push('judges');
        if (typeof p.dropHighLow !== 'boolean') missing.push('dropHighLow');
        if (!(Number(p.advancementTopN) > 0)) missing.push('advancementTopN');
        return { missing, preset: p };
      }

      // Populate dropdown
      Preset.list().forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });

      // Display selected preset details
      select.addEventListener('change', () => {
        const p = Preset.get(select.value);
        tableBody.innerHTML = '';
        if (!p) return;
        Object.entries(p).forEach(([k,v]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td><b>${k}</b></td><td>${Array.isArray(v)?v.join(', '):v}</td>`;
          tableBody.appendChild(tr);
        });
      });

      // Save snapshot
      saveBtn.addEventListener('click', () => {
        const id = select.value;
        const p = Preset.get(id);
        if (!cid || !id || !p) { UI.toast('Missing preset or CID'); return; }
        const check = evaluatePreset(p);
        if (check.missing.length) {
          console.warn(`âš  Missing: ${check.missing.join(', ')}`, { cid, presetId: id, preset: p });
          UI.toast('Preset incomplete: ' + check.missing.join(', '));
          return;
        }
        State.setJSON('preset_snapshot_'+cid, p);
        console.log('âœ… Preset complete', { cid, presetId: id });
        UI.toast('Preset saved for CID '+cid);
        auditPresetSnapshot();
        setTimeout(() => { window.location.href = './setup_new.html?cid='+encodeURIComponent(cid); }, 1000);
      });
    })();
  </script>
</body>
</html>
