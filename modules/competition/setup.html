<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Competition Setup • ARENA</title>
  <link rel="stylesheet" href="../../styles.css" />
  <style>
    :root {
      --blue: #2563eb;
      --navy: #1e3a8a;
      --orange: #F37021;
      --ink: #0f172a;
      --muted: #6b7280;
      --line: #e5e7eb;
      --bg: #ffffff;
      --chip: #111827;
      --soft: #f8fafc;
    }

    body {
      background: #fafafa;
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
    }

    /* Hero header → blue gradient, same as centers */
    header {
      background: linear-gradient(180deg, var(--blue) 0%, var(--navy) 100%);
      color: #fff;
      padding: 72px 24px 96px;
      border-bottom: 1px solid rgba(0, 0, 0, .15);
      text-align: left;
    }

    header h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: .2px;
      font-weight: 800;
    }

    header p {
      margin: 8px 0 0;
      opacity: .92;
      font-size: 15px;
    }

    /* Floating content overlap under the hero */
    .wrap {
      max-width: 1100px;
      margin: -56px auto 0;
      padding: 0 24px 32px;
    }

    .bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin: 0 0 16px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
    }

    .btn {
      display: inline-block;
      border: 1px solid var(--chip);
      background: #fff;
      color: var(--chip);
      padding: 10px 14px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
    }

    .btn:hover {
      background: #f1f5f9;
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
    }

    /* Safe enhancement for existing “Run” action (uses .btn.primary already in your HTML) */
    .btn.primary {
      background: #2563eb;
      color: #fff;
      border-color: #1e40af;
    }

    .btn.primary:hover {
      background: #1e40af;
      border-color: #1e3a8a;
      box-shadow: 0 6px 16px rgba(37, 99, 235, .28);
    }

    /* Inputs/selects in the toolbar */
    select,
    input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .18);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    /* Table container scroll safety on mobile */
    #listSection {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      min-width: 760px;
      /* keep columns readable on small screens while allowing scroll */
      border-collapse: separate;
      border-spacing: 0;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
    }

    .table th,
    .table td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      font-size: 14px;
      vertical-align: middle;
    }

    .table th {
      background: #f8fafc;
      font-weight: 800;
      position: sticky;
      top: 0;
      z-index: 1;
      /* sticky header when scrolling wide */
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    /* Row zebra + hover */
    .table tbody tr:nth-child(even) {
      background: #fcfdff;
    }

    .table tbody tr:hover {
      background: #f3f6ff;
    }

    .status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: #fff;
    }

    .empty {
      padding: 28px;
      border: 1px dashed var(--line);
      border-radius: 16px;
      background: #fff;
      color: var(--muted);
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .04);
    }

    footer {
      padding: 16px;
      text-align: center;
      color: var(--muted);
    }

    .actions a {
      margin-right: 8px;
    }

    .pill {
      font-size: 12px;
      color: #a7f3d0;
    }

    /* Responsive tweaks */
    @media (max-width:820px) {
      .bar {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .bar .muted {
        font-size: 14px;
      }
    }
  </style>

</head>

<body>
  <header>
    <h1>Competition Setup</h1>
    <p>Create and manage competitions before approval.</p>
  </header>

  <main class="wrap">
    <div class="bar">
      <div class="muted">
        <strong>Status:</strong>
        <select id="filterStatus">
          <option value="ALL">All</option>
          <option value="Draft">Draft</option>
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
        </select>
        &nbsp;&nbsp;
        <strong>Sort:</strong>
        <select id="sortBy">
          <option value="updated_desc">Updated (new→old)</option>
          <option value="updated_asc">Updated (old→new)</option>
          <option value="date_asc">Event Date (asc)</option>
          <option value="date_desc">Event Date (desc)</option>
          <option value="name_asc">Name (A→Z)</option>
          <option value="name_desc">Name (Z→A)</option>
        </select>
      </div>
      <div>
        <a class="btn" id="btnNew" href="./setup_new.html">➕ Create New Competition</a>
      </div>
    </div>

    <div style="margin-top:10px;">
      <strong>Search:</strong>
      <input id="searchText" type="text" placeholder="Name or CID" style="padding:8px 10px;border:1px solid #cbd5e1;
         border-radius:10px;width:220px;">
    </div>


    <section id="listSection">
      <!-- Table injected by script -->
    </section>

    <div id="emptyState" class="empty" style="display:none;">
      <p>No competitions created yet.</p>
      <p><em>Use the button above to create a new competition.</em></p>
    </div>
  </main>

  <footer>
    <a class="btn" href="/pages/competition_center.html">⬅️ Back to Competition Center</a>
  </footer>

  <!-- Page-only logic. No shared JS touched. -->
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const activeCid = params.get('cid');
      const cidBadge = document.getElementById('cidBadge');
      if (activeCid) cidBadge.textContent = 'Active CID: ' + activeCid;

      // ---- Data load / normalize
      function loadCompetitions() {
        let raw = null;
        try { raw = JSON.parse(localStorage.getItem('arena_competitions_setup')); } catch (_) { }
        if (!raw) return [];
        const arr = Array.isArray(raw) ? raw : Object.values(raw);

        // Normalize minimal fields
        return arr.map(it => {
          const sch = (it.schedule || {});
          const judge = (it.judging || {});
          return {
            cid: it.cid || it.id || '',
            name: it.name || '—',
            date: (sch.startDate && sch.endDate)
              ? `${sch.startDate} → ${sch.endDate}`
              : (sch.startDate || '—'),
            venue: sch.venue || '—',
            status: it.status || it.approvalStatus || 'Draft',
            tz: sch.timezone || '',
            categories: it.events || [],
            // show “something” for judges: either panel size placeholders or roles array
            judges: (judge.panelSize && judge.panelSize > 0)
              ? Array.from({ length: judge.panelSize })
              : (judge.roles || []),
            // mark scoring present if criteria exist (we don’t need details here)
            scoring: (judge.criteria && judge.criteria.length) ? { criteriaCount: judge.criteria.length } : null,
            updatedAt: (it.meta && it.meta.updatedAt) || it.updatedAt || it.lastUpdated || it.modifiedAt || null,
            owner: it.owner || it.createdBy || ''
          };
        });

      }

      // ---- Completion % (tweak the required list to your contract)
      const REQUIRED_KEYS = ['name', 'date', 'venue', 'tz', 'categories', 'judges', 'scoring'];
      function completionPercent(it) {
        const total = REQUIRED_KEYS.length;
        let filled = 0;
        if (it.name && it.name.trim()) filled++;
        if (it.date && it.date !== '—') filled++;
        if (it.venue && it.venue !== '—') filled++;
        if (it.tz) filled++;
        if (Array.isArray(it.categories) && it.categories.length) filled++;
        if (Array.isArray(it.judges) && it.judges.length) filled++;
        if (it.scoring) filled++;
        return Math.round((filled / total) * 100);

      }

      // ---- Filters / sort
      function applyFilterSort(items) {
        const f = (document.getElementById('filterStatus') || { value: 'ALL' }).value;
        const s = (document.getElementById('sortBy') || { value: 'updated_desc' }).value;

        let out = (f === 'ALL') ? items : items.filter(x => (x.status || 'Draft') === f);

        // Search by name or CID (case-insensitive)
        const qEl = document.getElementById('searchText');
        const q = qEl ? String(qEl.value || '').toLowerCase() : '';
        if (q) {
          out = out.filter(x =>
            String(x.name || '').toLowerCase().includes(q) ||
            String(x.cid || '').toLowerCase().includes(q)
          );
        }


        const getTime = v => v ? (new Date(v)).getTime() : 0;
        const getEventTime = v => v && v !== '—' ? (new Date(v)).getTime() : 0;

        switch (s) {
          case 'updated_asc': out.sort((a, b) => getTime(a.updatedAt) - getTime(b.updatedAt)); break;
          case 'updated_desc': out.sort((a, b) => getTime(b.updatedAt) - getTime(a.updatedAt)); break;
          case 'date_asc': out.sort((a, b) => getEventTime(a.date) - getEventTime(b.date)); break;
          case 'date_desc': out.sort((a, b) => getEventTime(b.date) - getEventTime(a.date)); break;
          case 'name_asc': out.sort((a, b) => String(a.name).localeCompare(String(b.name))); break;
          case 'name_desc': out.sort((a, b) => String(b.name).localeCompare(String(a.name))); break;
        }
        return out;
      }

      // ---- Render
      function renderList(items) {
        const listSection = document.getElementById('listSection');
        const empty = document.getElementById('emptyState');

        if (!items.length) {
          listSection.innerHTML = '';
          empty.style.display = 'block';
          return;
        }
        empty.style.display = 'none';

        const rows = items.map(it => {
          const pct = completionPercent(it);
          const cid = it.cid ? `<code>${it.cid}</code>` : '—';
          const updated = it.updatedAt ? new Date(it.updatedAt).toLocaleString() : '—';
          return `
        <tr>
          <td style="font-weight:600">${it.name}<div class="muted">${cid}</div></td>
          <td>${it.date}</td>
          <td>${it.venue}</td>
          <td><span class="status">${it.status || 'Draft'}</span></td>
          <td>${pct}%</td>
          <td>${updated}</td>
          <td class="actions">
            <a class="btn" href="./setup_new.html?cid=${encodeURIComponent(it.cid || '')}">Edit</a>
            <a class="btn primary" href="../../pages/run_console.html?cid=${encodeURIComponent(it.cid)}&eid=default&heat=1">Run</a>
          </td>

        </tr>
      `;
        }).join('');

        listSection.innerHTML = `
      <table class="table" aria-label="Competitions in setup">
        <thead>
          <tr>
            <th style="width:28%">Competition</th>
            <th style="width:14%">Date</th>
            <th style="width:18%">Venue</th>
            <th style="width:12%">Status</th>
            <th style="width:10%">Complete</th>
            <th style="width:18%">Last Updated</th>
            <th style="width:10%">Actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
      }

      // ---- Init
      const all = loadCompetitions();
      const filtered = applyFilterSort(all);
      renderList(filtered);

      // Hook up controls
      const fs = document.getElementById('filterStatus');
      const sb = document.getElementById('sortBy');
      [fs, sb].forEach(el => el && el.addEventListener('change', () => {
        const data = applyFilterSort(all);
        renderList(data);
      }));
      const q = document.getElementById('searchText');
      if (q) q.addEventListener('input', () => {
        const data = applyFilterSort(all);
        renderList(data);
      });
    })();
  </script>

</body>

</html>