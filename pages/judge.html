<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Judge View</title>
  <link rel="stylesheet" href="../styles.css">

  <style>
    body {
      background: #f8fafc;
      font-family: system-ui, sans-serif;
      margin: 0;
    }

    .wrap {
      max-width: 480px;
      margin: 2rem auto;
      padding: 1rem;
    }

    h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .05);
    }

    label {
      display: block;
      margin-top: .75rem;
      font-weight: 600;
    }

    input[type=number] {
      width: 100%;
      padding: .6rem;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1.1rem;
      text-align: center;
    }

    button {
      width: 100%;
      margin-top: 1.2rem;
      padding: .8rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .muted {
      color: #6b7280;
      text-align: center;
      margin-top: .5rem;
      font-size: .9rem;
    }

    /* --- Olympic-grade Judge UI polish --- */
    .mast {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, #0b1020, #111827);
      color: #e5edff;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      margin: -1rem -1rem 1rem;
      padding: .75rem 1rem;
      border-radius: 0 0 12px 12px;
    }

    .mast-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .75rem;
    }

    .mast .tag {
      background: #2563eb;
      /* Bright Echo Blue */
      color: #fff;
      /* White text */
      border-radius: 50px;
      padding: .35rem .9rem;
      font-weight: 700;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.25);
    }


    .total-badge {
      margin: .75rem 0 .25rem;
      text-align: center;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 1.75rem;
    }

    .hint {
      color: #6b7280;
      font-size: .9rem;
      text-align: center;
      margin-top: .35rem;
    }

    .btn-primary {
      background: #2563eb;
      color: #fff;
    }

    .btn-primary:disabled {
      background: #9ca3af;
    }

    .btn-lg {
      font-size: 1.05rem;
      padding: 1rem;
      border-radius: 12px;
    }

    input[type=number] {
      font-size: 1.15rem;
      text-align: center;
      background: #fbfdff;
    }

    input[type=number]:focus {
      outline: 2px solid #2563eb33;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px #2563eb22;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>Judge Console</h2>
    <div class="mast">
      <div class="mast-row">
        <span class="tag" id="mastJudge">Judge: —</span>
        <span class="tag" id="mastAthlete">Athlete: —</span>
        <span class="tag" id="mastTimer">00:00</span>
      </div>
    </div>

    <div class="card">
      <div id="info" class="muted"></div>
      <button id="btnSubmit">Lock & Submit</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

  <script>
    // --- Params ---
    const p = new URLSearchParams(location.search);
    const cid = p.get('cid') || '';
    const eid = p.get('eid') || '';
    const heat = p.get('heat') || '';
    const jid = (p.get('j') || '').toUpperCase();
    const aid = p.get('aid') || '';

    // --- Athlete name lookup (from localStorage: athletes_<cid>) ---
    function jget(k, fb) { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fb; } catch (_) { return fb; } }
    const aRaw = jget('athletes_' + cid, { athletes: [] });
    const aList = Array.isArray(aRaw) ? aRaw : (aRaw.athletes || []);
    const ATHMAP = {};
    aList.forEach(a => {
      const id = String(a.aid || a.id || '');
      if (id) ATHMAP[id] = a.name || id;
    });
    const aname = ATHMAP[String(aid)] || aid || '—';

    // --- Mast header wiring
    const mastJudge = document.getElementById('mastJudge');
    const mastAth = document.getElementById('mastAthlete');
    const mastTimer = document.getElementById('mastTimer');
    const info = document.getElementById('info');

    if (mastJudge) mastJudge.textContent = `Judge: ${jid || '—'}`;
    if (mastAth) mastAth.textContent = `Athlete: ${aname}${aid ? ' (' + aid + ')' : ''}`;
    if (info) info.textContent = `CID=${cid} • EID=${eid} • HEAT=${heat} • Judge=${jid} • Athlete=${aname}${aid ? ' (' + aid + ')' : ''}`;

    let t0 = Date.now(), tId = setInterval(() => {
      const s = Math.floor((Date.now() - t0) / 1000),
        mm = String(Math.floor(s / 60)).padStart(2, '0'),
        ss = String(s % 60).padStart(2, '0');
      if (mastTimer) mastTimer.textContent = `${mm}:${ss}`;
    }, 250);

    // --- Elements ---
    const wrap = document.querySelector('.card');
    const btn = document.getElementById('btnSubmit');
    const msg = document.getElementById('msg');

    // --- Helpers ---
    const now = () => new Date().toLocaleTimeString([], { hour12: false });
    const LS = {
      get(k, fb = null) { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fb; } catch { return fb; } },
      set(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
    };

    // --- Load scoring criteria from Setup-New ---
    const scoringKey = `scoring_${cid}`;
    const scoringObj = LS.get(scoringKey, {
      criteria: [
        { label: 'Difficulty', weight: 1 },
        { label: 'Execution', weight: 1 },
        { label: 'Flow', weight: 1 }
      ]
    });
    const criteria = scoringObj.criteria || [];
    const fields = [];

    // --- Build dynamic fields (keypad-friendly, range guarded) ---
    criteria.forEach((c, idx) => {
      const lbl = document.createElement('label');
      lbl.textContent = `${c.label} (×${c.weight})`;

      const inp = document.createElement('input');
      inp.type = 'number'; inp.step = '0.01'; inp.placeholder = '0–100';
      inp.dataset.label = c.label; inp.dataset.weight = c.weight;
      inp.min = '0'; inp.max = '100'; inp.inputMode = 'decimal'; inp.autocomplete = 'off';
      if (idx === 0) inp.autofocus = true;

      wrap.insertBefore(inp, btn); wrap.insertBefore(lbl, inp);
      fields.push(inp);
    });

    // --- Big total badge (preview) ---
    const totalBadge = document.createElement('div');
    totalBadge.className = 'total-badge';
    totalBadge.textContent = 'Total: 0.00';
    wrap.insertBefore(totalBadge, btn);

    function computeTotal() {
      let t = 0, w = 0;
      fields.forEach(f => {
        const v = parseFloat(f.value), wt = parseFloat(f.dataset.weight) || 1;
        if (!isNaN(v)) { t += v * wt; w += wt; }
      });
      return w ? (t / w) : 0;
    }
    function refreshTotal() {
      const val = computeTotal();
      totalBadge.textContent = 'Total: ' + val.toFixed(2);
    }
    fields.forEach(f => {
      f.addEventListener('input', () => {
        // clamp 0..100
        let v = parseFloat(f.value);
        if (!isNaN(v)) { if (v < 0) v = 0; if (v > 100) v = 100; f.value = v; }
        refreshTotal();
      });
    });

    // --- Safe unload (warn if not submitted) ---
    let submitted = false;
    window.addEventListener('beforeunload', (e) => {
      if (!submitted) {
        e.preventDefault(); e.returnValue = ''; // show browser prompt
      }
    });

    function lockUI() {
      fields.concat([btn]).forEach(el => el.disabled = true);
      submitted = true;
      msg.textContent = 'Submitted at ' + now();
      clearInterval(tId);
    }

    // --- Submit (confirm, validate, emit) ---
    btn.classList.add('btn-primary', 'btn-lg');
    btn.onclick = () => {
      // validation
      for (const f of fields) {
        const val = parseFloat(f.value);
        if (isNaN(val) || val < 0 || val > 100) {
          alert('All scores must be between 0–100'); return;
        }
      }

      const scores = {};
      fields.forEach(f => {
        const key = f.dataset.label.toLowerCase().replace(/\s+/g, '_');
        scores[key] = parseFloat(f.value);
      });
      const total = computeTotal();
      if (!confirm(`Submit ${total.toFixed(2)} for ${jid} → ${aid}? This locks your scores.`)) return;

      const pkt = {
        type: 'judge_status', cid, eid, heat,
        judgeId: jid, athleteId: aid,
        scores, total, status: 'locked'
      };
      localStorage.setItem('judge_status', JSON.stringify(pkt));
      localStorage.setItem('judge_status_tick', String(Date.now()));
      lockUI();
    };

    // initial paint
    refreshTotal();
  </script>


</body>

</html>